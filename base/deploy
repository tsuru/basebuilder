#!/bin/bash -el

# Copyright 2015 basebuilder authors. All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

cd /
SOURCE_DIR=/var/lib/tsuru

if [ $# -lt 1 ]
then
	echo "Usage:"
	echo
	echo "  % $0 <type> [param_1] [param_2] ... [param_n]"
	exit 1
fi

function git_deploy() {
	if [ ! -d $CURRENT_DIR/.git ]
	then
		rm -rf $CURRENT_DIR
	fi
	if [ -d $CURRENT_DIR ]
	then
		cd $CURRENT_DIR
		git reset --hard
		git fetch origin
		cd -
	else
		git clone $1 $CURRENT_DIR
	fi
	cd $CURRENT_DIR
	git submodule update --init --recursive
	git checkout $2 >/dev/null 2>&1
	cd -
}

function archive_deploy() {
	if [ -d $CURRENT_DIR ]
	then
		sudo rm -rf $CURRENT_DIR
	fi
	mkdir -p $CURRENT_DIR
	curl -sSfNL $1 -o /tmp/archive.tar.gz
	tar -C $CURRENT_DIR -xzf /tmp/archive.tar.gz
	rm /tmp/archive.tar.gz
}

function pre_deploy() {
	if [ -f ${APP_DIR}/.default_procfile ]
	then
		rm ${APP_DIR}/.default_procfile ${CURRENT_DIR}/Procfile
	fi
}

function post_deploy() {
	if [ ! -f ${CURRENT_DIR}/Procfile ] && [ -f ${SOURCE_DIR}/utils/Procfile ]
	then
		cp ${SOURCE_DIR}/utils/Procfile ${CURRENT_DIR}/Procfile
		touch ${APP_DIR}/.default_procfile
	fi
}


source ${SOURCE_DIR}/config
source ${SOURCE_DIR}/so_dependencies

pre_deploy
case $1 in
	"git")
		git_deploy $2 $3
		shift; shift; shift
		;;
	"archive")
		archive_deploy $2
		shift; shift;
		;;
	*) # backward compatibility, when type is not specified
		git_deploy $1 $2
		shift; shift
		;;
esac
post_deploy

if [[ $@ != "" ]]; then
	export $@
else
	export TSURU_DEPLOY_NO_ENVS=1
fi

so_dependencies
